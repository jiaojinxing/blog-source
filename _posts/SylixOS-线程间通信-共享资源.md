title: SylixOS 线程间通信-共享资源
date: 2015-06-25 17:00:25
tag: 
- SylixOS 
- 线程间通信
- 书稿
categories: 
- SylixOS 
---

##什么是共享资源##

一个基于RTOS的应用层软件往往需要多个线程才能实现，多个线程可能需要同时访问同一个变量、同一个设备或同一块内存，这时该变量、该设备或该内存块被称为**共享资源**。

如果在访问共享资源时不独占该共享资源，可能会造成变量值异常、设备出错或内存块内容不是期望值，从而导致程序运行异常甚至崩溃。
比如现在有两个线程需要同时将同一个变量V（初始值为0）进行自增操作。

在RISC机器上，一般都是Load/store体系结构，即访问内存只允许load和store操作；变量V的自增操作流程如下：

1.	加载变量V的地址到CPU的工作寄存器0；
2.	load指令将工作寄存器0指向的地址的内容加载工作寄存器1； 
3.	inc指令将工作寄存器1的值加一；
4.	store指令将工作寄存器1的值储存到工作寄存器0指向的地址。

变量V的自增操作不是一步完成的，如果线程A和线程B依次完成以上四步，那么变量V最后的值将会是2。

如果线程A完成前面三步，这时线程B打断了线程A的工作，线程B将变量V改写为1；最后线程A继续执行第四步，那么变量V最后的值仍然是1，这显然不是我们期望的。

为了解决这个问题，我们可以加入一把锁，在进行变量V的自增操作前占有该锁；锁具有排它性，其它线程如果也要占有该锁，将被阻塞；这样确保了同一时间只有一个线程能访问该变量，待自增操作完成后释放该锁，这样变量V的自增操作就不会混乱了。

这时我们称被锁保护的区域为**临界区**。

在多线程环境下，小小的一个变量操作都需要小心对待，更不用说复杂的设备了。所以说多线程编程是一把双刃剑，它可以使用我们的程序更易实现，但需要我们更小心的处理。好在SylixOS操作系统已经为我们准备好大量解决多线程编程问题的解决方案，比如信号量、互斥锁、消息队列等等。
